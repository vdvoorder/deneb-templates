{
  "data": {
    "values": [
      {"Category": "a", "Actual": 500, "Target": 450},
      {"Category": "b", "Actual": 295, "Target": 300},
      {"Category": "c", "Actual": 351, "Target": 350},
      {"Category": "d", "Actual": 205, "Target": 250}
    ]
  },
  "params": [{"name": "NearTargetBoundary", "value": 0.1}],
  "transform": [
    {"calculate": "max(datum['Actual'], datum['Target'])", "as": "Max"},
    {"calculate": "datum['Actual'] - datum['Target']", "as": "Difference"},
    {
      "calculate": "round(100 * abs(datum['Actual'] - datum['Target']) / datum['Target']) + \"% \" + if(datum['Actual'] === datum['Target Value'], \"−\", if(datum['Actual'] > datum['Target'], \"▲\",\"▼\"))",
      "as": "ActualLabel"
    },
    {"fold": ["Actual", "Target"], "as": ["ActualTarget", "Value"]},
    {
      "calculate": "if(datum['ActualTarget'] === \"Target\", \"Target\", if(datum['Difference'] >= 0, \"Over\", if(abs(datum['Difference'] / datum['Target']) <= NearTargetBoundary, \"Near\", \"Under\")))",
      "as": "ActualState"
    }
  ],
  "layer": [
    {
      "description": "All filled bars",
      "mark": {"type": "bar", "opacity": 0.5},
      "encoding": {
        "x": {"field": "Value"},
        "fill": {
          "field": "ActualState",
          "type": "nominal",
          "sort": ["Target", "Under", "Near", "Over"],
          "scale": {"range": ["lightgray", "crimson", "gold", "dodgerblue"]}
        }
      }
    },
    {
      "description": "Strokes at end of Actual bars",
      "transform": [{"filter": "datum['ActualTarget'] === \"Actual\""}],
      "mark": {
        "type": "point",
        "shape": "stroke",
        "angle": 90,
        "size": 320,
        "strokeWidth": 3
      },
      "encoding": {
        "x": {"field": "Value"},
        "color": {
          "field": "ActualState",
          "type": "nominal",
          "sort": ["Under", "Near", "Over"],
          "scale": {"range": ["crimson", "gold", "dodgerblue"]},
          "legend": null
        }
      }
    },
    {
      "description": "want labels to either use max of Actual or Target as x encoding so they never overlap with a bar. TODO: find way to either use max of Actual and Target as x encoding or enforce correct color scale for labels",
      "transform": [
        {
          "filter": "if(datum['Actual'] > datum['Target'], datum['ActualTarget'] === \"Actual\", datum['ActualTarget'] === \"Target\")"
        }
      ],
      "mark": {"type": "text", "align": "left", "dx": 5},
      "encoding": {
        "x": {"field": "Value"},
        "color": {
          "field": "ActualState",
          "sort": ["Under", "Near", "Over"],
          "scale": {"range": ["crimson", "gold", "dodgerblue"]},
          "legend": null
        },
        "text": {"field": "ActualLabel"}
      }
    }
  ],
  "encoding": {
    "x": {"type": "quantitative", "stack": null},
    "y": {"field": "Category", "type": "nominal", "sort": "-x"}
  },
  "config": {"axis": {"title": null}}
}