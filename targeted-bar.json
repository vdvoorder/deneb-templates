{
  "data": {
    "values": [
      {"Category": "a", "Actual": 500, "Target": 450},
      {"Category": "b", "Actual": 295, "Target": 300},
      {"Category": "c", "Actual": 351, "Target": 350},
      {"Category": "d", "Actual": 205, "Target": 250}
    ]
  },
  "params": [{"name": "NearTargetBoundary", "value": 0.1}],
  "transform": [
    {"calculate": "datum['Actual'] - datum['Target']", "as": "Difference"},
    {"fold": ["Actual", "Target"]},
    {
      "calculate": "if(datum['key'] === \"Target\", \"Target\", if(datum['Difference'] >= 0, \"Over\", if(abs(datum['Difference'] / datum['Target']) <= NearTargetBoundary, \"Near\", \"Under\")))",
      "as": "ActualState"
    }
  ],
  "layer": [
    {
      "description": "All filled bars",
      "mark": {"type": "bar", "opacity": 0.5},
      "encoding": {
        "x": {"field": "value"},
        "fill": {
          "field": "ActualState",
          "type": "nominal",
          "sort": ["Target", "Under", "Near", "Over"],
          "scale": {"range": ["lightgray", "crimson", "gold", "dodgerblue"]}
        }
      }
    },
    {
      "description": "Actual Value strokes at end of bars",
      "transform": [{"filter": "datum['key'] === \"Actual\""}],
      "mark": {
        "type": "point",
        "shape": "stroke",
        "angle": 90,
        "size": 320,
        "strokeWidth": 3
      },
      "encoding": {
        "x": {"field": "Actual"},
        "color": {
          "field": "ActualState",
          "type": "nominal",
          "sort": ["Under", "Near", "Over"],
          "scale": {"range": ["crimson", "gold", "dodgerblue"]},
          "legend": null
        }
      }
    }
  ],
  "encoding": {
    "x": {"type": "quantitative", "stack": null},
    "y": {
      "field": "Category",
      "type": "nominal",
      "sort": {"encoding": "x", "order": "descending"}
    }
  },
  "config": {"axis": {"title": null}}
}