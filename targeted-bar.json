{
  "data": {
    "values": [
      {"Category": "a", "Actual": 500, "Target": 450},
      {"Category": "b", "Actual": 295, "Target": 300},
      {"Category": "c", "Actual": 351, "Target": 350},
      {"Category": "d", "Actual": 205, "Target": 250}
    ]
  },
  "params": [{"name": "NearTargetBoundary", "value": 0.1}],
  "transform": [
    {
      "calculate": "if(datum.Actual - datum.Target >= 0, 'Over target', if((abs(datum.Actual - datum.Target) / datum.Target) <= NearTargetBoundary, 'Near target', 'Under target'))",
      "as": "ActualState"
    },
    {
      "calculate": "round(100 * abs(datum.Actual - datum.Target) / datum.Target) + '% ' + if(datum.Actual === datum.Target, '−', if(datum.Actual > datum.Target, '▲','▼'))",
      "as": "ActualLabel"
    },
    {"calculate": "'Target'", "as": "TargetDummy"},
    {"calculate": "max(datum.Actual, datum.Target)", "as": "Max"}
  ],
  "layer": [
    {
      "description": "Target bars",
      "mark": {"type": "bar"},
      "encoding": {
        "x": {"field": "Target"},
        "fill": {"field": "TargetDummy"},
        "stroke": {"value": "gray"}
      }
    },
    {
      "description": "Actual bars",
      "mark": {"type": "bar", "opacity": 0.5},
      "encoding": {
        "x": {"field": "Actual"},
        "fill": {
          "field": "ActualState",
          "scale": {"range": ["gold", "dodgerblue", "lightgray", "crimson"]}
        }
      }
    },
    {
      "description": "Actual strokes at end of bars",
      "mark": {
        "type": "point",
        "shape": "stroke",
        "angle": 90,
        "size": 300,
        "strokeWidth": 3
      },
      "encoding": {
        "x": {"field": "Actual"},
        "color": {"field": "ActualState"}
      }
    },
    {
      "description": "Actual labels at end of bars",
      "mark": {"type": "text", "align": "left", "dx": 5},
      "encoding": {
        "x": {"field": "Max"},
        "color": {
          "field": "ActualState",
          "scale": {"range": ["gold", "dodgerblue", "crimson"]},
          "legend": null
        },
        "text": {"field": "ActualLabel"}
      }
    }
  ],
  "encoding": {
    "x": {"type": "quantitative"},
    "y": {"field": "Category", "type": "nominal", "sort": {"field": "Actual", "op": "sum", "order": "descending"}}
  },
  "config": {}
}